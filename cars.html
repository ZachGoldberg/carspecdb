<html>
<head>

<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="DT_bootstrap.css">

<script src="jquery.js"></script>
<script src="jquery.dataTables.js"></script>
<script type="text/javascript" charset="utf-8" language="javascript" src="DT_bootstrap.js"></script>

</head>
<body>

<form id="carform" action="#">
Make: <input name="make" id="carmake"><br>
Model: <input name="model" id="carmodel"><br>
Trim: <input name="trim" id="cartrim"><br>
Year: <input name="year" id="caryear"><br>
<input type="submit">
</form>

<div id="carstatus">
</div>

<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" id="cartable">
	<thead>
		<tr>
			<th>Year</th>
			<th>Make</th>
			<th>Model</th>
			<th>Trim</th>
            <th>Engine Position</th>
            <th>Engine Displacement</th>
            <th># Cylinders</th>
            <th>Engine Type</th>
            <th>Valves per Cyl.</th>
            <th>Power (ps)</th>
            <th>Power RPM</th>
            <th>Torque (nm)</th>
            <th>Torque RPM</th>
            <th>Bore (mm)</th>
            <th>Stroke (mm)</th>
            <th>Compression Ratio</th>
            <th>Fuel</th>
            <th>Top Speed (kph)</th>
            <th>0 to 100 kph</th>
            <th>Drive</th>
            <th>Transmission Type</th>
            <th>Seats</th>
            <th>Doors</th>
            <th>Weight (kg)</th>
            <th>Length (mm)</th>
            <th>Width (mm)</th>
            <th>Height (mm)</th>
            <th>Wheelbase</th>
            <th>Highway mpg</th>
            <th>Mixed MPG</th>
            <th>City MPG</th>
            <th>Fuel Capacity (l)</th>
		</tr>
	</thead>
    <tbody>
    </tbody>
</table>

<script>
$(document).ready(function() {

  $.xhrPool = [];
  $.xhrPool.abortAll = function() {
    $(this).each(function(idx, jqXHR) {
        jqXHR.abort();
    });
    $.xhrPool.length = 0
  };

  $.ajaxSetup({
      beforeSend: function(jqXHR) {
          $.xhrPool.push(jqXHR);
      },
      complete: function(jqXHR) {
          var index = $.xhrPool.indexOf(jqXHR);
          if (index > -1) {
              $.xhrPool.splice(index, 1);
          }
      }
  });

	$('#cartable').dataTable( {
		"sDom": "<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",
		"sPaginationType": "bootstrap",
        "bDeferRender": true,
        "bFilter": false,
		"oLanguage": {
			"sLengthMenu": "_MENU_ records per page"
		}
	} );

});

$("#carform").submit(doSearch);
$("#carmake").keyup(doSearch);
$("#carmodel").keyup(doSearch);
$("#caryear").keyup(doSearch);
$("#cartrim").keyup(doSearch);

var ev;
function doSearch() {
   $("#carstatus").text("Searching...");
   make = $("#carmake").val()
   model = $("#carmodel").val()
   year = $("#caryear").val()
   trim = $("#cartrim").val()
   console.log(make);
   $.xhrPool.abortAll();
   $.ajax({
        type: "GET",
        url: "/backend/?make=" + make + "&model=" + model + "&year=" + year + "&trim=" + trim,
        dataType: "json",
        success: function(data) {processData(data);}
   });
   if (event.type != "keypress") {
     event.preventDefault();
   }
}

function processData(results) {
   var start = new Date().getTime();
   var table = $('#cartable').DataTable();
   table.clear();
   headers = results[0]
   var rows = [];
   for (var i = 1; i < results.length; i++) {
      data = results[i]
      var r = {};
      for (var j=0; j < headers.length; j++) {
            r[headers[j]] = data[j];
      }
      rows.push([r.model_year, r.model_make_display, r.model_name,
                 r.model_trim, r.model_engine_position, r.model_engine_cc,
                 r.model_engine_num_cyl, r.model_engine_type, r.mode_engine_valves_per_cyl,
                 r.model_engine_power_ps, r.model_engine_power_rpm, r.model_engine_torque_nm,
                 r.model_engine_torque_rpm, r.model_engine_bore_mm, r.model_engine_stroke_mm,
                 r.model_engine_compression, r.model_engine_fuel, r.model_top_speed_kph,
                 r.model_0_to_100_kph, r.model_drive, r.model_transmission_type, r.model_seats,
                 r.model_doors, r.model_weight_kg, r.model_length_mm, r.model_width_mm,
                 r.model_height_mm, r.model_wheelbase, r.model_lkm_hwy, r.model_lkm_mixed,
                 r.model_lkm_city, r.model_fuel_cap_l]);
   }
   console.log("Time for csv math: " + (new Date().getTime() - start));
   table.rows.add(rows);
   console.log("Time for row additions: " + (new Date().getTime() - start));
   table.draw();
   $("#carstatus").text("Search Complete, " + (results.length - 1) + " Results");
   console.log("Time for csv + table draw: " + (new Date().getTime() - start) + ", " + (results.length - 1) + " results");
}

</script>
</body>


</html>
